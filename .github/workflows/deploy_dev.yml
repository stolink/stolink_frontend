name: Frontend CICD

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # AWS ì¸ì¦ì„ ìœ„í•œ OIDC í† í° ë°œí–‰ ê¶Œí•œ
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL_DEV }}
          REACT_APP_MEDIA_URL: "https://${{ vars.CLOUDFRONT_URL_DEV }}/media"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.S3_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy Frontend to S3
        run: |
          # ë¹Œë“œ ê²°ê³¼ í´ë”ê°€ distì¸ì§€ buildì¸ì§€ í™•ì¸ í›„ ìˆ˜ì •í•˜ì‹­ì‹œì˜¤.
          # ì˜ˆ: ./dist ê°€ ë§žë‹¤ë©´ ì•„ëž˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          aws s3 sync ./dist s3://${{ vars.FRONTEND_S3_BUCKET_NAME_DEV }} --delete

      - name: CloudFront Invalidation
        run: |
          # URLì„ í†µí•´ Distribution IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?DomainName=='${{ vars.CLOUDFRONT_URL_DEV }}'].Id | [0]" --output text)

          # ìºì‹œ ë¬´íš¨í™” ì‹¤í–‰
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
name: Frontend CI/CD

on:
  push:
    branches:
      - main

permissions:
  id-token: write # OIDCìš©
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          REACT_APP_MEDIA_URL: "https://${{ vars.CLOUDFRONT_URL }}/media"

      - name: Generate version info
        id: version
        run: |
          VERSION="${{ github.sha }}"
          SHORT_SHA="${VERSION:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "version=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "{\"version\":\"${SHORT_SHA}\",\"commit\":\"${{ github.sha }}\",\"timestamp\":\"${TIMESTAMP}\",\"branch\":\"${{ github.ref_name }}\"}" > ./dist/version.json
          echo "âœ… Generated version.json with version: ${SHORT_SHA}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./dist
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_S3FULL_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy Frontend to S3
        run: |
          aws s3 sync ./dist s3://${{ vars.FRONTEND_S3_BUCKET_NAME }} --delete

      - name: CloudFront Invalidation
        run: |
          # URLì„ í†µí•´ Distribution IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
          DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?DomainName=='${{ vars.CLOUDFRONT_URL }}'].Id | [0]" --output text)

          # ìºì‹œ ë¬´íš¨í™” ì‹¤í–‰
          aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"

      - name: Health Check
        run: |
          URL="https://${{ vars.CLOUDFRONT_URL }}"
          MAX_RETRIES=5
          RETRY_INTERVAL=10

          echo "ðŸ” Starting health check for: $URL"

          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Health check passed! (attempt $i)"
              exit 0
            fi
            echo "â³ Attempt $i/$MAX_RETRIES: Status $STATUS, retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.build.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${{ vars.CLOUDFRONT_URL }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
