name: AI Code Review

on:
  # ì½”ë©˜íŠ¸ë¡œ íŠ¸ë¦¬ê±° (/review) - main ë¸Œëžœì¹˜ì— ë¨¸ì§€ í›„ ë™ìž‘
  issue_comment:
    types: [created]
  # ë¼ë²¨ë¡œ íŠ¸ë¦¬ê±° - feature ë¸Œëžœì¹˜ì—ì„œë„ ë™ìž‘
  pull_request:
    types: [labeled]

jobs:
  ai_review:
    # Trigger conditions:
    # 1. PR comment with /review
    # 2. PR labeled with 'ai-review'
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request' && github.event.label.name == 'ai-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files
        id: diff
        run: |
          git fetch origin main
          DIFF=$(git diff origin/main...HEAD --name-only | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get diff content
        id: diff_content
        run: |
          CONTENT=$(git diff origin/main...HEAD -- '*.ts' '*.tsx' --stat | head -50)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call Claude API
        id: review
        run: |
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-haiku-4-5-20251001",
              "max_tokens": 2048,
              "messages": [{
                "role": "user",
                "content": "ë‹¤ìŒ PRì˜ ë³€ê²½ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ì½”ë“œ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\në³€ê²½ëœ íŒŒì¼:\n${{ steps.diff.outputs.files }}\n\në³€ê²½ í†µê³„:\n${{ steps.diff_content.outputs.content }}\n\n## ì¶œë ¥ í˜•ì‹\n### ðŸ”´ ì¹˜ëª…ì  (ìžˆìœ¼ë©´)\n**íŒŒì¼:ë¼ì¸** - ë¬¸ì œ ì„¤ëª…\n\n### âš ï¸ ê²½ê³  (ìžˆìœ¼ë©´)\n**íŒŒì¼:ë¼ì¸** - ë¬¸ì œ ì„¤ëª…\n\n### ðŸ’¡ ì œì•ˆ (ìžˆìœ¼ë©´)\n- ê°œì„  ì œì•ˆ\n\nì´ìŠˆê°€ ì—†ìœ¼ë©´ âœ… ì´ìƒ ì—†ìŒ ìœ¼ë¡œ ì‘ë‹µ."
              }]
            }')

          # Extract text from response
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "ë¦¬ë·° ìƒì„± ì‹¤íŒ¨"')

          # Save to file to handle multiline
          echo "$REVIEW" > review_result.txt

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ðŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n${review}`
            });
