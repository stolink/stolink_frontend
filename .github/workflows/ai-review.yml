name: AI Code Review

on:
  # ì½”ë©˜íŠ¸ë¡œ íŠ¸ë¦¬ê±° (/review) - main ë¸Œëœì¹˜ì— ë¨¸ì§€ í›„ ë™ì‘
  issue_comment:
    types: [created]
  # ë¼ë²¨ë¡œ íŠ¸ë¦¬ê±° - feature ë¸Œëœì¹˜ì—ì„œë„ ë™ì‘
  pull_request:
    types: [labeled]

jobs:
  ai_review:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request' && github.event.label.name == 'ai-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files and diff
        id: diff
        run: |
          git fetch origin main

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          FILES=$(git diff origin/main...HEAD --name-only -- '*.ts' '*.tsx' | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì‹¤ì œ ì½”ë“œ ë³€ê²½ ë‚´ìš© (ìµœëŒ€ 300ì¤„)
          DIFF=$(git diff origin/main...HEAD -- '*.ts' '*.tsx' | head -500)
          echo "$DIFF" > diff_content.txt

      - name: Prepare prompt
        id: prompt
        run: |
          DIFF_CONTENT=$(cat diff_content.txt | head -c 15000)

          cat > prompt.json << 'PROMPT_EOF'
          {
            "model": "claude-haiku-4-5-20251001",
            "max_tokens": 2048,
            "messages": [{
              "role": "user",
              "content": "## ì—­í• \nSto-Link í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ ê°œë°œìë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.\n\n## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸\n- ìŠ¤í† ë¦¬, ë³µì„ , ìºë¦­í„° ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì‘ê°€ìš© ì›¹ì•±\n- ê¸°ìˆ  ìŠ¤íƒ: React, TypeScript, Zustand, TanStack Query, Tiptap\n- í•µì‹¬ íƒ€ì…: Project, Chapter, Character, Foreshadowing\n\n## ë¦¬ë·° ê¸°ì¤€\n1. **ì¹˜ëª…ì **: ëŸ°íƒ€ì„ ì—ëŸ¬, íƒ€ì… ì˜¤ë¥˜, ë³´ì•ˆ ì·¨ì•½ì \n2. **ê²½ê³ **: ì„±ëŠ¥ ì´ìŠˆ, ì•ˆí‹°íŒ¨í„´, Zustand ìƒíƒœ ê´€ë¦¬ ë¬¸ì œ\n3. **ì œì•ˆ**: ì½”ë“œ ìŠ¤íƒ€ì¼, ë¦¬íŒ©í† ë§ ê¸°íšŒ\n\n## ì¤‘ì  ê²€í†  í•­ëª©\n- TypeScript íƒ€ì… ì•ˆì „ì„± (any ì‚¬ìš©, non-null assertion ë‚¨ìš©)\n- Zustand ìŠ¤í† ì–´ ì„¤ê³„ (ì§ë ¬í™” ê°€ëŠ¥ ì—¬ë¶€, ìƒíƒœ ë¶„ë¦¬)\n- React í›… ì˜ì¡´ì„± ë°°ì—´\n- ê¸°ì¡´ ë°ì´í„° êµ¬ì¡°ì™€ì˜ í˜¸í™˜ì„±\n\n## ë³€ê²½ëœ íŒŒì¼\nFILES_PLACEHOLDER\n\n## ì½”ë“œ ë³€ê²½ ë‚´ìš©\n```diff\nDIFF_PLACEHOLDER\n```\n\n## ì¶œë ¥ í˜•ì‹ (ì´ í˜•ì‹ë§Œ ì¶œë ¥, ë‹¤ë¥¸ ì„¤ëª… ê¸ˆì§€)\n\n### ğŸ”´ ì¹˜ëª…ì  (Nê±´)\n**íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©\n- ë¬¸ì œ: ì„¤ëª…\n- ê°œì„ : ì½”ë“œ ì˜ˆì‹œ\n\n### âš ï¸ ê²½ê³  (Nê±´)\n**íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©\n> ì„¤ëª…\n\n### ğŸ’¡ ì œì•ˆ (Nê±´)\n- íŒŒì¼: ì œì•ˆ ë‚´ìš©\n\n(ì´ìŠˆ ì—†ëŠ” ì¹´í…Œê³ ë¦¬ëŠ” ìƒëµ, ë¬¸ì œ ì—†ìœ¼ë©´ 'âœ… ì´ìƒ ì—†ìŒ' ì¶œë ¥)"
            }]
          }
          PROMPT_EOF

          # Replace placeholders
          FILES="${{ steps.diff.outputs.files }}"
          sed -i "s|FILES_PLACEHOLDER|$FILES|g" prompt.json

          # Escape diff content for JSON
          ESCAPED_DIFF=$(echo "$DIFF_CONTENT" | jq -Rs '.')
          # Remove quotes added by jq
          ESCAPED_DIFF=${ESCAPED_DIFF:1:-1}
          sed -i "s|DIFF_PLACEHOLDER|$ESCAPED_DIFF|g" prompt.json

      - name: Call Claude API
        id: review
        run: |
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @prompt.json)

          # Extract text from response
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "ë¦¬ë·° ìƒì„± ì‹¤íŒ¨"')

          # Check for error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "API Error: $ERROR" > review_result.txt
          else
            echo "$REVIEW" > review_result.txt
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n${review}`
            });
