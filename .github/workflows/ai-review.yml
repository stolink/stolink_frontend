name: AI Code Review

on:
  # ì½”ë©˜íŠ¸ë¡œ íŠ¸ë¦¬ê±° (/review) - main ë¸Œëœì¹˜ì— ë¨¸ì§€ í›„ ë™ì‘
  issue_comment:
    types: [created]
  # ë¼ë²¨ë¡œ íŠ¸ë¦¬ê±° - feature ë¸Œëœì¹˜ì—ì„œë„ ë™ì‘
  pull_request:
    types: [labeled]

jobs:
  ai_review:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review')) ||
      (github.event_name == 'pull_request' && github.event.label.name == 'ai-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files and diff
        id: diff
        run: |
          git fetch origin main

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          FILES=$(git diff origin/main...HEAD --name-only -- '*.ts' '*.tsx' | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì‹¤ì œ ì½”ë“œ ë³€ê²½ ë‚´ìš© (ìµœëŒ€ 300ì¤„)
          DIFF=$(git diff origin/main...HEAD -- '*.ts' '*.tsx' | head -500)
          echo "$DIFF" > diff_content.txt

      - name: Prepare prompt
        id: prompt
        run: |
          DIFF_CONTENT=$(cat diff_content.txt | head -c 15000)
          FILES="${{ steps.diff.outputs.files }}"

          # Create template file
          cat << 'EOF' > prompt_template.txt
          ## ì—­í• 
          Sto-Link í”„ë¡œì íŠ¸ì˜ ì‹œë‹ˆì–´ ê°œë°œìë¡œì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

          ## í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
          - ìŠ¤í† ë¦¬, ë³µì„ , ìºë¦­í„° ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì‘ê°€ìš© ì›¹ì•±
          - ê¸°ìˆ  ìŠ¤íƒ: React, TypeScript, Zustand, TanStack Query, Tiptap
          - í•µì‹¬ íƒ€ì…: Project, Chapter, Character, Foreshadowing

          ## ë¦¬ë·° ê¸°ì¤€
          1. **ì¹˜ëª…ì **: ëŸ°íƒ€ì„ ì—ëŸ¬, íƒ€ì… ì˜¤ë¥˜, ë³´ì•ˆ ì·¨ì•½ì 
          2. **ê²½ê³ **: ì„±ëŠ¥ ì´ìŠˆ, ì•ˆí‹°íŒ¨í„´, Zustand ìƒíƒœ ê´€ë¦¬ ë¬¸ì œ
          3. **ì œì•ˆ**: ì½”ë“œ ìŠ¤íƒ€ì¼, ë¦¬íŒ©í† ë§ ê¸°íšŒ

          ## ì¤‘ì  ê²€í†  í•­ëª©
          - TypeScript íƒ€ì… ì•ˆì „ì„± (any ì‚¬ìš©, non-null assertion ë‚¨ìš©)
          - Zustand ìŠ¤í† ì–´ ì„¤ê³„ (ì§ë ¬í™” ê°€ëŠ¥ ì—¬ë¶€, ìƒíƒœ ë¶„ë¦¬)
          - React í›… ì˜ì¡´ì„± ë°°ì—´
          - ê¸°ì¡´ ë°ì´í„° êµ¬ì¡°ì™€ì˜ í˜¸í™˜ì„±

          ## ë³€ê²½ëœ íŒŒì¼
          FILES_PLACEHOLDER

          ## ì½”ë“œ ë³€ê²½ ë‚´ìš©
          ```diff
          DIFF_PLACEHOLDER
          ```

          ## ì¶œë ¥ í˜•ì‹ (ì´ í˜•ì‹ë§Œ ì¶œë ¥, ë‹¤ë¥¸ ì„¤ëª… ê¸ˆì§€)

          ### ğŸ”´ ì¹˜ëª…ì  (Nê±´)
          **íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©
          - ë¬¸ì œ: ì„¤ëª…
          - ê°œì„ : ì½”ë“œ ì˜ˆì‹œ

          ### âš ï¸ ê²½ê³  (Nê±´)
          **íŒŒì¼:ë¼ì¸** - ì´ìŠˆ ì œëª©
          > ì„¤ëª…

          ### ğŸ’¡ ì œì•ˆ (Nê±´)
          - íŒŒì¼: ì œì•ˆ ë‚´ìš©

          (ì´ìŠˆ ì—†ëŠ” ì¹´í…Œê³ ë¦¬ëŠ” ìƒëµ, ë¬¸ì œ ì—†ìœ¼ë©´ 'âœ… ì´ìƒ ì—†ìŒ' ì¶œë ¥)
          EOF

          # Use jq to generate JSON safely
          jq -n \
            --arg model "claude-3-5-haiku-20241022" \
            --rawfile template prompt_template.txt \
            --arg files "$FILES" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: $model,
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: ($template | sub("FILES_PLACEHOLDER"; $files) | sub("DIFF_PLACEHOLDER"; $diff))
              }]
            }' > prompt.json

      - name: Call Claude API
        id: review
        run: |
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @prompt.json)

          # Extract text from response
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "ë¦¬ë·° ìƒì„± ì‹¤íŒ¨"')

          # Check for error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "API Error: $ERROR" > review_result.txt
          else
            echo "$REVIEW" > review_result.txt
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ğŸ¤– AI ì½”ë“œ ë¦¬ë·°\n\n${review}`
            });
