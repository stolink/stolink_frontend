name: AI Code Review

on:
  # ÏΩîÎ©òÌä∏Î°ú Ìä∏Î¶¨Í±∞ (/review) - ÏàòÎèô Ïã§Ìñâ
  issue_comment:
    types: [created]
  # PR ÏÉùÏÑ± Î∞è ÏóÖÎç∞Ïù¥Ìä∏ Ïãú ÏûêÎèô Ïã§Ìñâ
  pull_request:
    types: [opened, synchronize]

jobs:
  ai_review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            # ÏΩîÎ©òÌä∏ Ìä∏Î¶¨Í±∞ ÏãúÏóêÎèÑ PR ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏôÄ base branch ÌôïÏù∏
            BASE_BRANCH=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq '.baseRefName')
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files and diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="${{ steps.pr.outputs.base_branch }}"
          git fetch origin $BASE_BRANCH

          # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù (Base Branch Í∏∞Ï§Ä)
          FILES=$(git diff origin/$BASE_BRANCH...HEAD --name-only -- '*.ts' '*.tsx' | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Ïã§Ï†ú ÏΩîÎìú Î≥ÄÍ≤Ω ÎÇ¥Ïö© (Base Branch Í∏∞Ï§Ä, ÏµúÎåÄ 300Ï§Ñ)
          DIFF=$(git diff origin/$BASE_BRANCH...HEAD -- '*.ts' '*.tsx' | head -500)
          echo "$DIFF" > diff_content.txt

      - name: Prepare prompt
        id: prompt
        run: |
          DIFF_CONTENT=$(head -n 500 diff_content.txt)
          FILES="${{ steps.diff.outputs.files }}"

          # Create template file
          cat << 'EOF' > prompt_template.txt
          ## Ïó≠Ìï†
          Sto-Link ÌîÑÎ°úÏ†ùÌä∏Ïùò ÏãúÎãàÏñ¥ Í∞úÎ∞úÏûêÏù¥Ïûê UI/UX Ï†ÑÎ¨∏Í∞ÄÎ°úÏÑú ÏΩîÎìú Î¶¨Î∑∞Î•º ÏàòÌñâÌï©ÎãàÎã§.

          ## ÌîÑÎ°úÏ†ùÌä∏ Ïª®ÌÖçÏä§Ìä∏
          - Ïä§ÌÜ†Î¶¨, Î≥µÏÑ†, Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÍ≥ÑÎ•º Í¥ÄÎ¶¨ÌïòÎäî ÏûëÍ∞ÄÏö© ÏõπÏï±
          - Í∏∞Ïà† Ïä§ÌÉù: React, TypeScript, Zustand, TanStack Query, Tiptap
          - ÌïµÏã¨ ÌÉÄÏûÖ: Project, Chapter, Character, Foreshadowing

          ## Î¶¨Î∑∞ Í∏∞Ï§Ä
          1. **ÏπòÎ™ÖÏ†Å**: Îü∞ÌÉÄÏûÑ ÏóêÎü¨, ÌÉÄÏûÖ Ïò§Î•ò, Î≥¥Ïïà Ï∑®ÏïΩÏ†ê
          2. **Í≤ΩÍ≥†**: ÏÑ±Îä• Ïù¥Ïäà, ÏïàÌã∞Ìå®ÌÑ¥, Zustand ÏÉÅÌÉú Í¥ÄÎ¶¨ Î¨∏Ï†ú
          3. **Ï†úÏïà**: ÏΩîÎìú Ïä§ÌÉÄÏùº, Î¶¨Ìå©ÌÜ†ÎßÅ Í∏∞Ìöå

          ## Ï§ëÏ†ê Í≤ÄÌÜ† Ìï≠Î™©
          - TypeScript ÌÉÄÏûÖ ÏïàÏ†ÑÏÑ± (any ÏÇ¨Ïö©, non-null assertion ÎÇ®Ïö©)
          - Zustand Ïä§ÌÜ†Ïñ¥ ÏÑ§Í≥Ñ (ÏßÅÎ†¨Ìôî Í∞ÄÎä• Ïó¨Î∂Ä, ÏÉÅÌÉú Î∂ÑÎ¶¨)
          - React ÌõÖ ÏùòÏ°¥ÏÑ± Î∞∞Ïó¥
          - Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ÏôÄÏùò Ìò∏ÌôòÏÑ±
          - UI/UX ÏÇ¨Ïö©ÏÑ± Î∞è Ïã¨ÎØ∏ÏÑ± (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò, ÎîîÏûêÏù∏ ÏùºÍ¥ÄÏÑ±)

          ## Î≥ÄÍ≤ΩÎêú ÌååÏùº
          FILES_PLACEHOLDER

          ## ÏΩîÎìú Î≥ÄÍ≤Ω ÎÇ¥Ïö©
          ```diff
          DIFF_PLACEHOLDER
          ```

          ## Ï∂úÎ†• Í∑úÏπô
          1. üî¥ ÏπòÎ™ÖÏ†Å, ‚ö†Ô∏è Í≤ΩÍ≥†Í∞Ä ÌïòÎÇòÎùºÎèÑ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÏÑπÏÖò Ï∂úÎ†•
          2. üî¥, ‚ö†Ô∏èÍ∞Ä ÏóÜÏúºÎ©¥ Î∞òÎìúÏãú '‚úÖ ÏΩîÎìú Î¶¨Î∑∞ ÌÜµÍ≥º - ÏàòÏ†ï ÌïÑÏöî ÏÇ¨Ìï≠ ÏóÜÏùå' Ï∂úÎ†• ÌõÑ Ï¢ÖÎ£å
          3. üí° Ï†úÏïàÏùÄ ÏÑ†ÌÉùÏÇ¨Ìï≠Ïù¥ÎØÄÎ°ú 'ÏàòÏ†ï ÌïÑÏöî'Î°ú Ï∑®Í∏âÌïòÏßÄ ÏïäÏùå

          ## Ï∂úÎ†• ÌòïÏãù (Ïù¥ ÌòïÏãùÎßå Ï∂úÎ†•)

          ### üî¥ ÏπòÎ™ÖÏ†Å (NÍ±¥)
          **ÌååÏùº:ÎùºÏù∏** - Ïù¥Ïäà Ï†úÎ™©
          - Î¨∏Ï†ú: ÏÑ§Î™Ö
          - Í∞úÏÑ†: ÏΩîÎìú ÏòàÏãú

          ### ‚ö†Ô∏è Í≤ΩÍ≥† (NÍ±¥)
          **ÌååÏùº:ÎùºÏù∏** - Ïù¥Ïäà Ï†úÎ™©
          > ÏÑ§Î™Ö

          ---
          üí° **Ï∞∏Í≥† Ï†úÏïà** (ÏÑ†ÌÉùÏÇ¨Ìï≠, ÏàòÏ†ï Î∂àÌïÑÏöî)
          - Ï†úÏïà ÎÇ¥Ïö©

          (üî¥, ‚ö†Ô∏èÍ∞Ä ÏóÜÏúºÎ©¥: '‚úÖ ÏΩîÎìú Î¶¨Î∑∞ ÌÜµÍ≥º - ÏàòÏ†ï ÌïÑÏöî ÏÇ¨Ìï≠ ÏóÜÏùå' Îßå Ï∂úÎ†•)
          EOF

          # Use jq to generate JSON safely
          jq -n \
            --arg model "claude-haiku-4-5-20251001" \
            --rawfile template prompt_template.txt \
            --arg files "$FILES" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: $model,
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: ($template | sub("FILES_PLACEHOLDER"; $files) | sub("DIFF_PLACEHOLDER"; $diff))
              }]
            }' > prompt.json

      - name: Call Claude API
        id: review
        run: |
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d @prompt.json)

          # Extract text from response
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Î¶¨Î∑∞ ÏÉùÏÑ± Ïã§Ìå®"')

          # Check for error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "API Error: $ERROR" > review_result.txt
          else
            echo "$REVIEW" > review_result.txt
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_result.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ü§ñ AI ÏΩîÎìú Î¶¨Î∑∞\n\n${review}`
            });
